<?php 
namespace common\components; 
use Yii; 
use yii\base\Object;
use common\components\Types; 
//use yii\bootstrap\Html;


class InvoiceComponent extends Object
{

	private $_myInvoices; 
    private $_allInvoices;  
	private $_userId; 
	
	/* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    public function init()
    {
        if (! yii::$app->user->isGuest)
            $this->_userId = yii::$app->user->id; 

        return parent::init(); 
    }
    /* ******************************************************************************************************* */ 
    
    /* ******************************************************************************************************* */ 
    public function getAllInvoices()
	{
        if ($this->_allInvoices === null)
        {
              if (Yii::$app->user->can('admin_role'))
              {
                    
                    $invList = $this->_allInvoices(); 
                    $entryList = $this->_allInvoiceEntries(); 
                    foreach ($invList as $inv)
                    {
                        $arr = array_merge( $inv , ['items'=>$this->_extractEntries($inv['invoice_id'],$entryList)]);  
                        $this->_allInvoices[] = $arr; 
                    }
              }
                
        }
        return $this->_allInvoices; 
    }
	/* ******************************************************************************************************* */ 

    /* ******************************************************************************************************* */ 
    public function canUse($invoice_id)
    {

            if (Yii::$app->user->can('core_staff_role'))
                return true; 
            else 
                return ($this->isMember($project_id) || $this->isManager($project_id)); 
    }
    /* ******************************************************************************************************* */ 
    public function isMember($project_id)
    {

        $return  = false; 
        foreach($this->myProjects as $project)
            if ( $project['project_id'] == $project_id ) 
                $return = true; 

        return true; 

    }
    /* ******************************************************************************************************* */ 
    
    /* ******************************************************************************************************* */ 
    
   
    /* ******************************************************************************************************* */ 
    
    /* ******************************************************************************************************* */ 
    /* private functions */ 
    /* ******************************************************************************************************* */ 
   /* ******************************************************************************************************* */ 
    private function _extractEntries($invoice_id,&$list)
    {
            $return = []; 
            foreach($list as $l)
                if ($l['invoice_id'] == $invoice_id)
                    $return[] = $l;
            return $return;  
    }
    /* ******************************************************************************************************* */ 
   
   private  function _allInvoiceEntries() 
    {

            return (new \yii\db\Query())
                    ->select([
                            'ie.invoice_id', 'ie.resource_id', 'ie.resource_other', 'ie.unit_cost','ie.qty' ,           
                            'ie.total_cost'
                           ])
                    ->from('invoice_entry ie')
                    ->orderBy('ie.created_at DESC')
                    ->all();

         

    }
    /* ******************************************************************************************************* */ 
   
   private  function _allInvoices() 
    {

            return (new \yii\db\Query())
                    ->select([
                            'i.id as invoice_id', 'i.invoice_number','i.project_id', 'i.publish_status_id', 
                                'i.vat_status_id','i.amount','p.code'
                           ])
                    ->from('invoice i')
                    ->join('INNER JOIN','project p', 'p.id=i.project_id')
                    ->orderBy('i.created_at DESC')
                    ->all();

         

    }
   /* ******************************************************************************************************* */ 
     
    /* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    /* ******************************************************************************************************* */ 
    

}